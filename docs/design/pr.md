# 镍市数据大屏方案设计（MVP）

## 1. 项目背景与目标
- **定位**：构建一个展示镍市核心指标的 Web 独立站，面向内部及合作方，提供准实时行情与主要指标概览。
- **当前能力**：已有 LME、SHFE 两个采集脚本，可手动拉取实时与历史数据。
- **MVP 范围**：聚焦于单个大屏页面，不包含 AI 报告、权限系统、移动端适配等非核心功能。
- **上线目标**：快速验证大屏价值，打通“采集 → 存储 → API → 前端展示”的闭环，为后续服务器部署铺路。

## 2. 关键指标与展示模块
| 模块 | 展示内容 | 优先级 | 数据来源/备注 |
| --- | --- | --- | --- |
| 顶部概览 | 当前时间、主要合约最新价、涨跌幅、成交量、持仓量 | **P0 必做** | `intraday_snapshots`（LME：3M 合约；SHFE：NI0 主力） |
| 实时行情卡片 | LME / SHFE 当前合约详情：开高低收、昨结算、买卖价、涨跌额/幅 | **P0 必做** | 读取实时快照表中的最新记录 |
| 数据更新时间 | 最近采集成功时间、请求耗时 | **P0 必做** | `intraday_snapshots` 的 `captured_at`、`elapsed_seconds` |
| 近阶段走势 | 日线级 K 线或折线（近 30 天或可配置） | P1 重要 | 日线数据尚未入库前，以“待上线”占位提示 |
| 价差或对比区域 | LME vs SHFE 核心信号对比（价差、比率等） | P1 重要 | 指标计算完成前展示可识别的占位卡片 |
| 预留告警 | 异常波动或数据缺失提醒，占位 | P2 可选 | 依赖后续算法，MVP 仅展示说明 |

> 注：所有指标需标明单位（美元/吨、人民币/吨、手、% 等），并提供中文字段名以降低理解成本。

## 3. 刷新策略（建议）
- **采集频率**：LME、SHFE 采集任务每 30 秒轮询一次；失败时重试 1 次，仍失败则保留上次有效数据并记日志。
- **前端刷新**：
  - P0 模块（顶部概览、实时行情卡片、数据更新时间）每 30 秒刷新，与采集节奏保持一致。
  - P1 模块（走势、价差）每 5 分钟刷新一次，或由用户手动触发；数据尚未准备时显示“待上线”占位。
- **展示规则**：界面直接显示最近一次成功采集时间，不额外做延迟高亮，保持 MVP 简洁。

## 4. 数据保留策略
- **Intraday 快照**：保留最近 24 小时的数据，满足大屏回退、异常排查和短期分析需求；24 小时后通过定时任务自动清理旧记录。
- **Daily 数据**：长期保留，用于趋势图、AI 报告等功能；整体数据量小，后续迁移 PostgreSQL 时继续沿用。

## 5. 合约选择约定
- LME 展示固定为 3M 合约（AkShare 接口默认的主力快照）。
- SHFE 展示 AkShare 返回的主力合约 `NI0`（脚本已实现）。
- 后续若需要扩展其他合约或自动筛选，可在 P1/P2 阶段迭代，MVP 先保持固定配置。

## 6. 访问与部署策略
- **API 访问**：MVP 阶段为开放式接口，前端直接调用，无登录/鉴权；后续如需权限控制再扩展 Token 或 IP 白名单。
- **部署计划**：组件支持两种形态：
  - **本地开发模式**：直接运行采集脚本、API 服务、前端静态服务器，方便调试与测试；提供相应的启动命令在 README。
  - **生产部署模式**：所有组件（采集脚本、API、前端）通过 Docker 容器在同一台服务器运行，提供 Dockerfile 与 docker-compose。
- **日志策略**：采集脚本和 API 记录本地日志文件（按日滚动）；暂不接入外部告警系统。

## 7. 总体架构（自顶向下）
```
┌─────────┐        ┌────────────────┐        ┌──────────────┐        ┌──────────────┐
│ 大屏前端 │  <---> │ 内部数据 API   │  <---> │ 数据存储层     │  <---> │ 数据采集脚本 │
└─────────┘        └────────────────┘        └──────────────┘        └──────────────┘
        ↑                    ↑                          ↑                        │
        │                    │                          │                        │
        └─ 前端轮询 JSON 接口 └─ FastAPI/服务层         └─ SQLite（后续 PostgreSQL）   └─ AkShare/采集脚本
```

### 7.1 前端层（Dashboard）
- 技术栈：轻量 Vue/React + ECharts（或纯 HTML + Chart.js）；MVP 可用静态资源部署。
- 功能：定时轮询（30 秒），展示模块化卡片；数值格式化、单位转换、中文标签映射。
- 异常处理：接口超时或数据缺失时展示“刷新中/数据暂不可用”；P1 模块在数据未准备好时以“敬请期待/待上线”占位。

### 7.2 API 服务层
- 框架建议：FastAPI（轻量、内置文档、易于扩展）。
- 接口示例：
  - `GET /api/v1/dashboard/latest?exchange=LME`：返回实时快照及采集时间。
  - `GET /api/v1/dashboard/history?exchange=SHFE&days=30`：返回日线数据（准备好后启用）。
  - `GET /api/v1/dashboard/compare`：返回价差或其他对比指标（计算逻辑就绪后启用）。
- 响应结构：包含英文字段 + 中文描述，前端无需维护额外字典。
- 缓存策略：MVP 直接读取数据库；后续对热点指标可添加内存缓存。

### 7.3 数据存储层
- MVP 采用 `sqlite3`，数据库文件位于 `storage/data.db`（加入 `.gitignore`）。
- Schema（与 `storage.md` 保持一致）：
  - `intraday_snapshots(exchange, contract, quote_date, latest_price, ..., extras)`
  - `daily_market_data(exchange, trade_date, open, high, low, close, ..., extras)`
- Repository：`backend/src/storage/repository.py` 暴露 `save_intraday_snapshot`、`list_intraday(exchange, limit)`、`list_daily(exchange, start_date, end_date)` 等接口。
- 数据清洗：写入前统一字段名称、数值类型、空值处理。

### 7.4 数据采集层
- 现有脚本：`backend/src/collectors/lme_data_collection.py`、`backend/src/collectors/SHFE_data_collection.py`。
- 改造方向：
  1. 抽离公共逻辑（字段映射、数值转换）。
  2. 采集成功后调用 repository 入库。
  3. 记录异常日志，并将采集状态反馈给 API 层。
- 调度策略：MVP 使用本地定时任务（如 `schedule`）；服务器上线后可改用 `cron`、APScheduler 或 Celery。Docker 部署时准备对应的调度脚本或容器。

## 8. 交互流程（时序图）
```
采集脚本 -> Repository -> SQLite -> API -> 前端
1. 定时任务触发采集脚本，抓取 LME / SHFE 实时数据。
2. 采集脚本调用 repository 写入 `intraday_snapshots`。
3. 前端轮询 API；API 从 `intraday_snapshots` 拉最新记录返回。
4. 前端渲染卡片与图表。
5. 历史数据同理：采集脚本周期性获取日线数据，写入 `daily_market_data`，供趋势图使用。
```

## 9. MVP 迭代路线
| 里程碑 | 目标 | 核心产出 |
| --- | --- | --- |
| M0 环境准备 | 跑通采集脚本，引入 repository | `storage.md`、repository 雏形、SQLite 库文件 |
| M1 数据写入 | 实时数据入库，API 可读最新快照 | `save_intraday`、`GET /dashboard/latest` |
| M2 前端原型 | 大屏页面展示基础卡片 + 占位模块 | 静态网页/React/Vue Demo（P1 模块显示“待上线”） |
| M3 优化完善 | 中文字段映射、异常提示、基础对比指标 | 字段字典、价差计算逻辑（上线 P1 模块） |
| M4 可部署版本 | 文档完善、部署脚本、服务器切换预案 | README（含本地+Docker 启动说明）、Dockerfile、docker-compose、PostgreSQL 迁移说明 |

## 10. 接口与数据格式约定
- API 统一返回 `{ "data": {...}, "meta": {...}, "error": null }`。
- 数值字段统一为浮点数；无数据时返回 `null`。
- 附带 `label_cn` 进行英文字段 → 中文名称映射。
- 时间字段统一使用 ISO8601 字符串（UTC+8）。

## 11. 运维与监控
- 日志：采集脚本和 API 记录本地日志文件（按日滚动）。
- 健康检查：API 提供 `GET /health`，返回数据库连接状态与最近采集时间。
- 数据校验：Repository 写入时校验价格、涨跌幅等字段有效性。
- 告警：MVP 阶段不接入外部告警系统；上线后可视情况引入邮件/IM 推送。

## 12. 风险与缓解
| 风险 | 描述 | 缓解措施 |
| --- | --- | --- |
| 数据源波动 | AkShare 接口波动导致采集失败 | 重试 + 保留上次有效数据；API 提示“数据暂不可用” |
| SQLite 并发限制 | 高频写入可能造成锁等待 | MVP 单机运行控制频率；服务器上线后迁移 PostgreSQL |
| 大屏性能 | 前端频繁轮询导致卡顿 | 统一刷新节奏；必要时引入缓存/增量更新 |
| 字段扩展 | 新指标需扩展字段 | 使用 `extras` JSON；后续按需结构化 |

## 13. 文档与协作
- 设计文档：`docs/design/storage.md`（数据层）、`docs/design/pr.md`（顶层方案）。
- 开发文档：在 README 中补充运行、测试、部署说明（含本地模式与 Docker 模式）。
- 变更记录：每次 schema/接口调整同步更新文档，保持前后端一致。

## 14. 后续扩展（Beyond MVP）
- AI 自动报告：基于 `daily_market_data` + 模板生成早报/日报/周报。
- 告警系统：设定阈值，触发通知或高亮提示。
- 权限与多租户：服务器环境中引入角色、访问控制。
- 可视化优化：增加交互、分屏布局、移动端适配等。

---
此方案聚焦单大屏 MVP，强调数据流闭环与可演进性。若方案获批，可按“采集改造 → Repository → API → 前端”的顺序推进实现。
