# 镍市独立站设计概览

## 1. 项目背景与目标
- **目标用户**：内部业务、分析与研究人员，后续对外开放。
- **核心能力**：
  1. 实时展示 LME / SHFE 镍价与关键指标；
  2. 支撑 AI 自动生成早报 / 日报 / 周报 / 月报；
  3. 为资讯、图表等扩展能力提供统一数据源。
- **当前状态**：已完成采集、存储、调度、API 基础设施建设，并提供一键启动脚本；前端大屏和 AI 报告仍在规划中。

## 2. 系统架构
```
┌─────────┐        ┌────────────────┐        ┌──────────────┐        ┌──────────────┐
│ 数据大屏 │ <---->│ RESTful API     │ <----> │ 数据存储层     │ <----> │ 调度 / 采集层 │
└─────────┘        └────────────────┘        └──────────────┘        └──────────────┘
        ↑                     ↑                        ↑                        │
        │                     │                        │                        │
        │             `/docs`（Swagger）         sqlite3（默认）                │
        │                     │                        │                        │
        └─────── 前端轮询 ─────┴────────── API 读取/写入 ─────┴───── 定时写库 ───┘
```

## 3. 模块说明
| 模块 | 位置 | 职责 |
| --- | --- | --- |
| 采集（Collectors） | `backend/src/collectors/` | 调用 AkShare 抓取 LME / SHFE 实时和历史数据；目前以函数形式提供给调度器使用。 |
| 调度（Tasks） | `backend/src/tasks/` | `scheduler.py` 循环调用采集函数，写入仓储；支持 `--once` 调试模式与配置化间隔。 |
| 存储（Storage） | `backend/src/storage/` | 通过 sqlite3 保存实时/日线数据；提供 `save_*` 与 `list_*` 等接口，支持 24 小时保留与配置化迁移。 |
| API | `backend/src/api/` | FastAPI 服务，对外暴露 `health`、`latest`、`intraday`、`daily` 等接口、内置 Swagger 静态资源。 |
| 工具 | `run_all.py` | 一键启动调度器 + API，便于开发阶段快速体验。 |

## 4. 数据流程
1. 调度器按配置（默认实时 30 秒、日线每日 18:10）调用采集函数。
2. 采集结果映射为统一格式，写入 sqlite（`intraday_snapshots`、`daily_market_data`）。
3. API 从存储层读取数据，对外返回标准结构的 JSON，提供中文字段标签。
4. 前端或其他消费者定期调用 API 获取数据；AI 报告模块未来也将基于这些接口或直接拉库。

## 5. API 接口速览
| 方法 | 路径 | 说明 |
| --- | --- | --- |
| `GET /health` | 返回系统状态、最近一次 LME 实时时间、采集配置等。 |
| `GET /api/v1/dashboard/latest?exchange=lme` | 指定交易所最新一条实时快照。 |
| `GET /api/v1/dashboard/intraday?exchange=shfe&limit=30` | 最近 N 条实时快照。 |
| `GET /api/v1/dashboard/daily?exchange=lme&start_date=YYYY-MM-DD` | 日线历史数据，可指定日期范围。 |
| `/docs` | 集成本地 Swagger UI，方便调试和分享。 |

响应统一为 `{ "data": ..., "meta": { labels, ... }, "error": null }`，字段名已与存储层一致，便于直接消费。

## 6. 配置与部署建议
- **配置**：通过 `.env` 或环境变量配置数据库、调度频率、日志级别等；默认使用 `sqlite:///storage/data.db`，支持未来切换 PostgreSQL。
- **开发**：`python run_all.py` 启动调度 + API，调试时可配合 `--no-reload` 等参数；`requirements.txt` 集中管理依赖。
- **生产**：建议调度器和 API 独立进程运行，禁用 `--reload`，使用 systemd、Supervisor 或 Docker Compose 管理；数据库迁移至 PostgreSQL 以获更强一致性与并发能力。

## 7. 后续路线
| 优先级 | 项目 | 说明 |
| --- | --- | --- |
| 高 | 前端大屏原型 | 板块布局、实时/历史图表、指标对比；与 API 对接。 |
| 高 | AI 报告模版 | 接入存储数据生成固定格式报告，先聚焦日报/周报。 |
| 中 | 指标派生 & 缓存 | 例如价差、涨跌幅榜、热图等；可在 API 层增加缓存/派生计算。 |
| 中 | 数据告警体系 | 对采集失败、长时间未更新等场景报警。 |
| 低 | Docker 化部署 | 提供可复制的部署脚本，方便测试/生产环境一致化。 |

> 本文档与 `mvp-plan.md`、`storage.md` 配合使用：前者列出实施步骤，后者详细说明数据模型与仓储实现细节。***
